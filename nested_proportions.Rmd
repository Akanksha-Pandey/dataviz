```{r echo = FALSE, message = FALSE, warning = FALSE}
# run setup script
source("_common.R")

library(ggforce)
library(treemapify)
```

# Visualizing nested or changing proportions {#nested-proportions}

*The titanic figures in this chapter so far don't make sense, because they treat all people with unknown age as children. It would be better to rework the examples using the `Titanic` table which is used in the parallel sets example at the end.*


(ref:titanic-wrong-pie) Breakdown of passenger on the Titanic by class (1st, 2nd, or 3rd) and by gender (women or men, excluding children under the age of 16), shown as a pie chart. This figure is invalid, because the percentages add up to more than 100%. There is overlap between passenger classes and passenger gender, as every female and male passenger travelled in either 1st, 2nd, or 3rd class.

```{r titanic-wrong-pie, fig.width = 4.5, fig.asp = 0.8, fig.cap = '(ref:titanic-wrong-pie)'}
titanic_tidy <- reshape2::melt(Titanic)
titanic_tidy_no_crew <- filter(titanic_tidy, Class != "Crew")

n_passengers <- summarize(
  titanic_tidy_no_crew,
  count = sum(value)
)$count

titanic_sex <- filter(titanic_tidy_no_crew, Age != "Child") %>%
  group_by(Sex) %>%
  summarize(
    count = sum(value),
    percent = round(100*count/n_passengers, 1)
  ) %>%
  rename(type = Sex) %>%
  mutate(
    type = case_when(
      type == "Female" ~ "women",
      type == "Male" ~ "men"
    )
  )

titanic_class <- group_by(titanic_tidy_no_crew, Class) %>%
  summarize(
    count = sum(value),
    percent = round(100*count/n_passengers, 1)
  ) %>%
  rename(type = Class) %>%
  mutate(
    type = paste0(type, " class")
  )

titanic_sex_class <- rbind(titanic_sex, titanic_class)

titanic_pie <- titanic_sex_class %>%
  mutate(
    count_total = sum(count),
    end_angle = 2*pi*cumsum(count)/count_total,   # ending angle for each pie slice
    start_angle = lag(end_angle, default = 0),   # starting angle for each pie slice
    mid_angle = 0.5*(start_angle + end_angle),   # middle of each pie slice, for the text label
    hjust = ifelse(mid_angle>pi, 1, 0),
    vjust = ifelse(mid_angle<pi/2 | mid_angle>3*pi/2, 0, 1)
  )

rpie = 1
rlabel = 1.05 * rpie

p_titanic_pie <- ggplot(titanic_pie) + 
  geom_arc_bar(
    aes(
      x0 = 0, y0 = 0, r0 = 0, r = rpie,
      start = start_angle, end = end_angle, fill = type
    ),
    color = "white", size = 0.5
  ) +
  geom_text(
    aes(
      x = rlabel*sin(mid_angle),
      y = rlabel*cos(mid_angle),
      label = type,
      hjust = hjust, vjust = vjust
    ),
    family = dviz_font_family,
    size = 14/.pt
  ) +
  geom_text(
    aes(
      x = 0.6*sin(mid_angle),
      y = 0.6*cos(mid_angle),
      label = paste0(percent, "%")
    ),
    family = dviz_font_family,
    size = 12/.pt,
    color = c("white", "black", "black", "black", "black")
  ) +
  coord_fixed(clip = "off") +
  scale_x_continuous(
    limits = c(-1.5, 1.5), expand = c(0, 0), name = "", breaks = NULL, labels = NULL
  ) +
  scale_y_continuous(
    limits = c(-1.15, 1.15), expand = c(0, 0), name = "", breaks = NULL, labels = NULL
  ) +
  scale_fill_manual(
    values = c(`1st class` = "#009E73", `2nd class` = "#E69F00", `3rd class` = "#F0E442",
               men = "#0072B2", women = "#D55E00")
  ) +
  theme_dviz_map() +
  theme(legend.position = "none")

stamp_wrong(p_titanic_pie)
```


(ref:titanic-bad-bars) Breakdown of passenger on the Titanic by class (1st, 2nd, or 3rd) and by gender (women or men, excluding children under the age of 16), shown as a bar plot. Unlike Figure \@ref(fig:titanic-wrong-pie), this visualization is not technically wrong, since it doesn't imply that the bar heights need to add up to 100%. However, it also does not clearly indicate the overlap among different groups, and therefore I have labeled it "bad".


```{r titanic-bad-bars, fig.cap = '(ref:titanic-bad-bars2)'}
p_titanic_bars <- ggplot(titanic_sex_class) +
  aes(type, percent, fill = type) +
  geom_col() +
  scale_y_continuous(
    limits = c(0, 65),
    expand = c(0, 0),
    labels = function(x) paste0(x, "%"),
    name = "proportion of passengers"
  ) +
  scale_x_discrete(name = NULL) +
  scale_fill_manual(
    values = c(`1st class` = "#009E73", `2nd class` = "#E69F00", `3rd class` = "#F0E442",
               men = "#0072B2", women = "#D55E00")
  ) +
  coord_cartesian(clip = "off") +
  theme_dviz_hgrid() +
  theme(
    axis.line.x = element_blank(),
    axis.ticks.x = element_blank(),
    legend.position = "none",
    plot.margin = margin(3.5, 7, 3.5, 0)
  )

stamp_bad(p_titanic_bars)
```

(ref:titanic-nested-pie) *Figure caption...*

```{r titanic-nested-pie, fig.width = 5, fig.asp = 0.8, fig.cap = '(ref:titanic-nested-pie)'}
titanic_nested <- rename(titanic_tidy_no_crew, class = Class) %>%
  mutate(
    gender = factor(case_when(
      Sex == "Male" & Age == "Adult" ~ "men",
      Sex == "Female" & Age == "Adult" ~ "women",
      TRUE ~ "children"
    ), levels = c("men", "women", "children"))
  ) %>%
  group_by(class, gender) %>%
  summarize(
    gender_count = sum(value),
    gender_percent = round(100*gender_count/n_passengers, 1)
  ) %>%
  ungroup() %>%
  left_join(
    rename(titanic_tidy_no_crew, class = Class) %>%
      group_by(class) %>%
      summarize(
        count = sum(value),
        percent = round(100*count/n_passengers, 1)
      )
  )


titanic_pie_outer <- titanic_nested %>%
  mutate(
    count_total = sum(gender_count),
    end_angle = 2*pi*cumsum(gender_count)/count_total,   # ending angle for each pie slice
    start_angle = lag(end_angle, default = 0),   # starting angle for each pie slice
    mid_angle = 0.5*(start_angle + end_angle),   # middle of each pie slice, for the text label
    hjust = ifelse(mid_angle>pi, 1, 0),
    vjust = ifelse(mid_angle<pi/2 | mid_angle>3*pi/2, 0, 1),
    type = gender
  ) %>%
  filter(gender != "children")

titanic_pie_inner <- titanic_nested %>%
  filter(gender == "men") %>%
  mutate(
    count_total = sum(count),
    end_angle = 2*pi*cumsum(count)/count_total,   # ending angle for each pie slice
    start_angle = lag(end_angle, default = 0),   # starting angle for each pie slice
    mid_angle = 0.5*(start_angle + end_angle),   # middle of each pie slice, for the text label
    hjust = ifelse(mid_angle>pi, 1, 0),
    vjust = ifelse(mid_angle<pi/2 | mid_angle>3*pi/2, 0, 1),
    type = class
  ) %>%
  select(-gender, -gender_count, -gender_percent)

rpie1 = 0.6
rpie2 = 1
rlabel = 1.05 * rpie

p_titanic_pie <- ggplot() + 
  geom_arc_bar(data = titanic_pie_outer,
    aes(
      x0 = 0, y0 = 0, r0 = rpie1, r = rpie2,
      start = start_angle, end = end_angle, fill = type
    ),
    color = "white", size = 0.5
  ) +
  geom_arc_bar(data = titanic_pie_inner,
    aes(
      x0 = 0, y0 = 0, r0 = 0, r = rpie1,
      start = start_angle, end = end_angle, fill = type
    ),
    color = "white", size = 0.5
  ) +
  geom_text(data = titanic_pie_outer,
    aes(
      x = rlabel*sin(mid_angle),
      y = rlabel*cos(mid_angle),
      label = gender,
      hjust = hjust, vjust = vjust
    ),
    family = dviz_font_family,
    size = 14/.pt
  ) +
  geom_text(data = titanic_pie_outer,
    aes(
      x = 0.8*sin(mid_angle),
      y = 0.8*cos(mid_angle),
      label = gender_count
    ),
    family = dviz_font_family,
    size = 12/.pt
  ) +
  geom_text(data = titanic_pie_inner,
    aes(
      x = 0.3*sin(mid_angle),
      y = 0.3*cos(mid_angle),
      label = count
    ),
    family = dviz_font_family,
    size = 12/.pt
  ) +
  coord_fixed(clip = "off") +
  scale_x_continuous(
    limits = c(-1.5, 1.5), expand = c(0, 0), name = "", breaks = NULL, labels = NULL
  ) +
  scale_y_continuous(
    limits = c(-1.15, 1.15), expand = c(0, 0), name = "", breaks = NULL, labels = NULL
  ) +
  scale_fill_manual(
    values = c(`1st` = "#009E73", `2nd` = "#E69F00", `3rd` = "#F0E442",
               men = "#0072B2", women = "#D55E00")
  ) +
  theme_dviz_map() +
  theme(legend.position = "none")

p_titanic_pie
```

```{r tianic_treemap, fig.asp = 3/4}
ggplot(titanic_nested, aes(area = gender_count, subgroup = class, fill = interaction(class, gender))) +
  geom_treemap(color = "white", size = 0.5*.pt) + 
  geom_treemap_subgroup_text(
    family = dviz_font_family,
    colour = "grey30", place = "centre", alpha = 0.7,
    grow = TRUE
  ) +
  geom_treemap_subgroup_border(color = "white") +
  geom_treemap_text(
    aes(label = gender),
    family = dviz_font_family,
    colour = "black", place = "centre",
    grow = FALSE
  ) +
  coord_cartesian(clip = "off") +
  guides(colour = "none", fill = "none")


```

(ref:titanic-parallel-sets1) *Figure caption.*

```{r titanic-parallel-sets1, fig.cap = '(ref:titanic-parallel-sets1)'}
data <- reshape2::melt(Titanic)
data <- gather_set_data(data, 1:4)
data$x <- factor(data$x, levels = c("Sex", "Age", "Class", "Survived"))

ggplot(data, aes(x, id = id, split = y, value = value)) +
  geom_parallel_sets(aes(fill = Survived), alpha = 0.5, axis.width = 0.13) +
  geom_parallel_sets_axes(axis.width = 0.13, fill = "grey70", color = "grey70") +
  geom_parallel_sets_labels(
    color = 'black',
    family = dviz_font_family,
    size = 10/.pt,
    angle = 90
  ) +
  scale_x_discrete(
    name = NULL,
    expand = c(0, 0.3)
  ) +
  scale_y_continuous(breaks = NULL, expand = c(0, 0))+
  scale_fill_manual(
    values = c("#56B4E9", "#E69F00"),
    guide = "none"
  ) +
  theme_dviz_open() +
  theme(
    axis.line = element_blank(),
    axis.ticks = element_blank()
  )
```

By changing the order of the groups and the variable used for coloring, we can highlight different aspects of the data. While Figure \@ref(fig:titanic-parallel-sets1) tells a story about who survived and who did not, Figure \@ref(fig:titanic-parallel-sets2) tells a story about crew and passengers traveling in different classes.


(ref:titanic-parallel-sets2) *Figure caption.*

```{r titanic-parallel-sets2, fig.cap = '(ref:titanic-parallel-sets2)'}
data$x <- factor(data$x, levels = c("Class", "Age", "Sex", "Survived"))

ggplot(data, aes(x, id = id, split = y, value = value)) +
  geom_parallel_sets(aes(fill = Class), alpha = 0.5, axis.width = 0.13) +
  geom_parallel_sets_axes(axis.width = 0.13, fill = "grey70", color = "grey70") +
  geom_parallel_sets_labels(
    color = 'black',
    family = dviz_font_family,
    size = 10/.pt,
    angle = 90
  ) +
  scale_x_discrete(
    name = NULL,
    expand = c(0, 0.3)
  ) +
  scale_y_continuous(breaks = NULL, expand = c(0, 0))+
  scale_fill_manual(
    values = c(`1st` = "#009E73", `2nd` = "#E69F00", `3rd` = "#56B4E9", Crew = "#F0E442"),
    guide = "none"
  ) +
  theme_dviz_open() +
  theme(
    axis.line = element_blank(),
    axis.ticks = element_blank()
  )
```

Add mosaic plot? https://stackoverflow.com/a/45688044/4975218
