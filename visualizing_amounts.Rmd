```{r echo = FALSE, message = FALSE}
# run setup script
source("_common.R")
library(forcats)
```


# Visualizing amounts

## Bar plots

For example, we may be interested in the total ticket sales for the most popular movies on a given weekend. Table \@ref(tab:boxoffice-gross) shows the top-five weekend gross ticket sales on the Christmas weekend of 2017. The movie "Star Wars: The Last Jedi" was by far the most popular movie on that weekend, outselling the fourth- and fifth-ranked movies "The Greatest Showman" and "Ferdinand" by almost a factor of 10.

```{r boxoffice-gross}
# source: Box Office Mojo
# URL: http://www.boxofficemojo.com/weekend/chart/?view=&yr=2017&wknd=51&p=.htm
# downloaded: 2018-02-11

boxoffice <- data.frame(rank = 1:5,
                        title = c("Star Wars: The Last Jedi", "Jumanji: Welcome to the Jungle", "Pitch Perfect 3", "The Greatest Showman", "Ferdinand"),
                        title_short = c("Star Wars", "Jumanji", "Pitch Perfect 3", "Greatest Showman", "Ferdinand"),
                        amount = c(71565498, 36169328, 19928525, 8805843, 7316746),
                        amount_text = c("$71,565,498", "$36,169,328", "$19,928,525", "$8,805,843", "$7,316,746"))

boxoffice_display <- boxoffice %>%
  mutate(A = " ", B = " ", C = " ") %>%
  select(A, rank, title, amount_text, B, C) %>%
  rename(` ` = A,
         Rank = rank,
         Title = title,
         `Weekend gross` = amount_text,
         ` ` = B,
         ` ` = C)

knitr::kable(
  boxoffice_display,
  caption = 'Highest grossing movies for the weekend of December 22-24, 2017. Data source: Box Office Mojo (http://www.boxofficemojo.com/). Used with permission', booktabs = TRUE,
  row.names = FALSE,
  align = c('c', 'c', 'l', 'r', 'c', 'c')#,
  #format = "html",
  #table.attr = "style = \"width: 75%\""
)
```

This kind of data is commonly visualized with vertical bars. For each movie, we draw a bar that starts at zero and extends all the way to the dollar value for that movie's weekend gross (Figure \@ref(fig:boxoffice-vertical)). This visualization is called a *bar plot* or *bar chart*. Bar plots are most effective if, as is the case here, the bars are placed in order such that the values are continuously decreasing or increasing.

(ref:boxoffice-vertical) Highest grossing movies for the weekend of December 22-24, 2017, displayed as a bar plot. Data source: Box Office Mojo (http://www.boxofficemojo.com/). Used with permission

```{r boxoffice-vertical, fig.width = 8, fig.asp = .5, fig.cap = '(ref:boxoffice-vertical)'}
boxoffice %>%
  ggplot(aes(x = fct_reorder(title_short, rank), y = amount)) +
    geom_col(fill = "#56B4E9", width = 0.6, alpha = 0.9) +
    scale_y_continuous(expand = c(0, 0),
                       breaks = c(0, 2e7, 4e7, 6e7),
                       labels = c("0", "20", "40", "60"),
                       name = "weekend gross (million USD)") +
    scale_x_discrete(name = NULL,
                     expand = c(0, 0.4)) +
    theme_minimal_hgrid() +
    theme(axis.ticks.length = grid::unit(0, "pt"),
          axis.ticks = element_blank(),
          axis.title = element_text(size = 12))
```



(ref:boxoffice-rot-axis-tick-labels) Highest grossing movies for the weekend of December 22-24, 2017, displayed as a bar plot with rotated axis tick labels. Rotated axis tick labels tend to be difficult to read and require awkward space use undearneath the plot. For these reasons, I generally consider plots with rotated tick labels to be ugly. Data source: Box Office Mojo (http://www.boxofficemojo.com/). Used with permission


```{r boxoffice-rot-axis-tick-labels, fig.asp = 0.85, fig.cap = '(ref:boxoffice-rot-axis-tick-labels)'}
boxoffice %>%
  ggplot(aes(x = fct_reorder(title_short, rank), y = amount)) +
    geom_col(fill = "#56B4E9", alpha = 0.9) +
    scale_y_continuous(expand = c(0, 0),
                       breaks = c(0, 2e7, 4e7, 6e7),
                       labels = c("0", "20", "40", "60"),
                       name = "weekend gross (million USD)") +
    scale_x_discrete(name = NULL) +
    theme_minimal_hgrid() +
    theme(axis.ticks.length = grid::unit(0, "pt"),
          axis.ticks = element_blank(),
          axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1),
          axis.title = element_text(size = 12),
          plot.margin = margin(7, 14, 7, 7)) -> p_box_axrot

stamp_ugly(p_box_axrot)
```

(ref:boxoffice-horizontal) Highest grossing movies for the weekend of December 22-24, 2017, displayed as a horizontal bar plot. Data source: Box Office Mojo (http://www.boxofficemojo.com/). Used with permission

```{r boxoffice-horizontal, fig.cap = '(ref:boxoffice-horizontal)'}
ggplot(boxoffice, aes(x = fct_reorder(title_short, desc(rank)), y = amount)) +
  geom_col(fill = "#56B4E9", alpha = 0.9) +
  scale_y_continuous(limits = c(0, 7.5e7),
                     expand = c(0, 0),
                     breaks = c(0, 2e7, 4e7, 6e7),
                     labels = c("0", "20", "40", "60"),
                     name = "weekend gross (million USD)") +
  scale_x_discrete(name = NULL,
                   expand = c(0, 0.5)) +
  coord_flip() +
  theme_minimal_vgrid() +
  theme(axis.ticks.length = grid::unit(0, "pt"),
        axis.ticks = element_blank(),
        axis.title = element_text(size = 12))
```

(ref:boxoffice-horizontal-alphabetic) Highest grossing movies for the weekend of December 22-24, 2017, displayed as a horizontal bar plot. Here, the bars have been placed in alphabetic order based on the movie titles. This arrangement of bars makes the resulting figure much less intuitive than Figure \@ref(fig:boxoffice-horizontal). Data source: Box Office Mojo (http://www.boxofficemojo.com/). Used with permission


```{r boxoffice-horizontal-alphabetic, fig.cap = '(ref:boxoffice-horizontal-alphabetic)'}
p <- ggplot(boxoffice, aes(x = fct_rev(title_short), y = amount)) +
  geom_col(fill = "#56B4E9", alpha = 0.9) +
  scale_y_continuous(limits = c(0, 7.5e7),
                     expand = c(0, 0),
                     breaks = c(0, 2e7, 4e7, 6e7),
                     labels = c("0", "20", "40", "60"),
                     name = "weekend gross (million USD)") +
  scale_x_discrete(name = NULL,
                   expand = c(0, 0.5)) +
  coord_flip() +
  theme_minimal_vgrid() +
  theme(axis.ticks.length = grid::unit(0, "pt"),
        axis.ticks = element_blank(),
        axis.title = element_text(size = 12))

stamp_bad(p)
```


(ref:income-by-age) 2016 median U.S. annual household income versus age group. The 45--54 year age group has the highest median income. Data source: United States Census Bureau

```{r income-by-age, fig.cap = '(ref:income-by-age)'}
income_by_age %>% filter(race == "all") %>%
  ggplot(aes(x = age, y = median_income)) +
    geom_col(fill = "#56B4E9", alpha = 0.9) +
    scale_y_continuous(expand = c(0, 0),
                       name = "median income (USD)",
                       breaks = c(0, 20000, 40000, 60000),
                       labels = c("$0", "$20,000", "$40,000", "$60,000")) +
    xlab("age (years)") +
    theme_minimal_hgrid() +
    theme(axis.ticks.length = grid::unit(0, "pt"),
          axis.ticks = element_blank(),
          axis.line = element_blank(),
          plot.margin = margin(7, 14, 7, 7))
```

(ref:income-by-age-sorted) 2016 median U.S. annual household income versus age group, sorted by income. While this order of bars looks visually appealing, the order of the age groups is now confusing. Data source: United States Census Bureau

```{r income-by-age-sorted, fig.cap = '(ref:income-by-age-sorted)'}
income_by_age %>% filter(race == "all") %>%
  ggplot(aes(x = fct_reorder(age, desc(median_income)), y = median_income)) +
    geom_col(fill = "#56B4E9", alpha = 0.9) +
    scale_y_continuous(expand = c(0, 0),
                       name = "median income (USD)",
                       breaks = c(0, 20000, 40000, 60000),
                       labels = c("$0", "$20,000", "$40,000", "$60,000")) +
    xlab("age (years)") +
    theme_minimal_hgrid() +
    theme(axis.ticks.length = grid::unit(0, "pt"),
          axis.ticks = element_blank(),
          axis.line = element_blank(),
          plot.margin = margin(7, 14, 7, 7)) -> p_income_sorted

stamp_bad(p_income_sorted)
```


## Grouped and stacked bars



(ref:income-by-age-race-dodged) *Figure caption goes here.* Data source: United States Census Bureau

```{r income-by-age-race-dodged, fig.width = 8, fig.asp = 0.5, fig.cap = '(ref:income-by-age-race-dodged)'}
income_by_age %>% filter(race %in% c("white", "asian", "black", "hispanic")) %>%
   mutate(race = fct_relevel(race, c("asian", "white", "hispanic", "black")),
          age = fct_recode(age, "â‰¥ 75" = "> 74")) -> income_df

# Take the darkest four colors from 5-class ColorBrewer palette "PuBu"
colors_four = RColorBrewer::brewer.pal(5, "PuBu")[5:2]

ggplot(income_df, aes(x = age, y = median_income, fill = race)) +
  geom_col(position = "dodge", alpha = 0.9) +
  scale_y_continuous(expand = c(0, 0),
                     name = "median income (USD)",
                     breaks = c(0, 20000, 40000, 60000, 80000, 100000),
                     labels = c("$0", "$20,000", "$40,000", "$60,000", "$80,000", "$100,000")) +
  scale_fill_manual(values = colors_four, name = NULL) +
  xlab("age (years)") +
  theme_minimal_hgrid() +
  theme(axis.ticks.length = grid::unit(0, "pt"),
        axis.ticks = element_blank(),
        axis.line = element_blank(),
        plot.margin = margin(7, 14, 7, 7)) -> p_income_race_dodged

stamp_ugly(p_income_race_dodged)
```

(ref:income-by-race-age-dodged) *Figure caption goes here.* Data source: United States Census Bureau


```{r income-by-race-age-dodged, fig.width = 8, fig.asp = 0.4, fig.cap = '(ref:income-by-race-age-dodged) '}
# Take the darkest seven colors from 8-class ColorBrewer palette "PuBu"
colors_seven = RColorBrewer::brewer.pal(8, "PuBu")[2:8]

ggplot(income_df, aes(x = race, y = median_income, fill = age)) +
  geom_col(position = "dodge", alpha = 0.9) +
  scale_y_continuous(expand = c(0, 0),
                     name = "median income (USD)",
                     breaks = c(0, 20000, 40000, 60000, 80000, 100000),
                     labels = c("$0", "$20,000", "$40,000", "$60,000", "$80,000", "$100,000")) +
  scale_fill_manual(values = colors_seven, name = "age (yrs)") +
  xlab(label = NULL) +
  theme_minimal_hgrid() +
  theme(axis.ticks.length = grid::unit(0, "pt"),
        axis.ticks = element_blank(),
        axis.line = element_blank(),
        legend.title.align = 0.5,
        plot.margin = margin(7, 14, 7, 7)) -> p_income_age_dodged

stamp_phantom(p_income_age_dodged)
```

(ref:income-by-age-race-faceted) *Figure caption goes here.* Data source: United States Census Bureau

```{r income-by-age-race-faceted, fig.width = 8.5, fig.cap = '(ref:income-by-age-race-faceted)'}
income_df %>%
   mutate(age = fct_recode(age, "15â€“24" = "15 to 24", "25â€“34" = "25 to 34", "35â€“44" = "35 to 44",
                                "45â€“54" = "45 to 54", "55â€“64" = "55 to 64", "65â€“74" = "65 to 74")) -> income_age_abbrev_df

ggplot(income_age_abbrev_df, aes(x = age, y = median_income)) +
  geom_col(fill = "#56B4E9", alpha = 0.9) +
  scale_y_continuous(expand = c(0, 0),
                     name = "median income (USD)",
                     breaks = c(0, 20000, 40000, 60000, 80000, 100000),
                     labels = c("$0", "$20,000", "$40,000", "$60,000", "$80,000", "$100,000")) +
  xlab(label = "age (years)") +
  facet_wrap(~race, scales = "free_x") +
  theme_minimal_hgrid(12) +
  theme(axis.ticks.length = grid::unit(0, "pt"),
        axis.ticks = element_blank(),
        axis.line = element_blank(),
        strip.text = element_text(size = 12),
        plot.margin = margin(6, 12, 6, 6)) -> p_income_age_dodged

stamp_phantom(p_income_age_dodged)
```


(ref:titanic-passengers-by-class-sex) Numbers of female and male passengers on the Titanic traveling in 1st, 2nd, and 3rd class.

```{r titanic-passengers-by-class-sex, fig.width = 5.5, fig.cap = '(ref:titanic-passengers-by-class-sex)'}
titanic_groups <- titanic_all %>% filter(class != "*") %>% 
  select(class, sex) %>% 
  group_by(class, sex) %>% 
  tally() %>% arrange(class, desc(sex)) %>%
  mutate(sex = factor(sex, levels = c("female", "male"))) %>%
  group_by(class) %>%
  mutate(nlabel = cumsum(n) - n/2) %>%
  ungroup() %>%
  mutate(class = paste(class, "class"))

ggplot(titanic_groups, aes(x = class, y = n, fill = sex)) +
  geom_col(position = "stack", color = "white", size = 1, width = 1) +
  geom_text(aes(y = nlabel, label = n), color = "white", size = 14/.pt) +
  scale_x_discrete(expand = c(0, 0), name = NULL) +
  scale_y_continuous(expand = c(0, 0), breaks = NULL, name = NULL) +
  scale_fill_manual(values = c("#D55E00", "#0072B2"),
                    breaks = c("female", "male"),
                    labels = c("female passengers   ", "male passengers"),
                    name = NULL) +
  theme_minimal_grid() +
  theme(panel.grid.major = element_blank(),
        axis.ticks = element_blank(),
        axis.text = element_text(size = 14),
        #legend.position = c(0.13, 0.6),
        #legend.justification = c(0, 0),
        legend.position = "bottom",
        legend.justification = "center",
        legend.background = element_rect(fill = "white"))
```


I have also added the actual numerical values that each bar represents. Whenever your plot is meant to display only a small number of key values, it makes sense to add the actual numbers to the plot. This substantially increases the amount of information conveyed by your plot without adding much visual noise.

**Mention that class cannot be reordered, because it is an ordered factor and it has its own intrinsic order.**

## Other visualization approaches

(ref:Americas-life-expect) Life expectancies of countries in the Americas, for the year 2007. Data source: Gapminder project

```{r Americas-life-expect, fig.width = 7., fig.asp = .8, fig.cap = '(ref:Americas-life-expect)'}
library(gapminder)
gap_asia_2007 <- gapminder %>% filter(year == 2007, continent == "Americas")
ggplot(gap_asia_2007, aes(x = lifeExp, y = fct_reorder(country, lifeExp))) +
  geom_point(color = "#0072B2", size = 2.5) +
  scale_x_continuous(name = "life expectancy (years)",
                     limits = c(59.7, 81.5),
                     expand = c(0, 0)) +
  scale_y_discrete(name = NULL, expand = c(0, 0.5)) +
  theme_minimal_grid() +
  theme(axis.ticks.length = grid::unit(0, "pt"),
        axis.title = element_text(size = 12),
        plot.margin = margin(7, 21, 7, 7))
```

(ref:Americas-life-expect-bad) Life expectancies of countries in the Americas, for the year 2007. **More text here.** Data source: Gapminder project

```{r Americas-life-expect-bad, fig.width = 7., fig.asp = .8, fig.cap = '(ref:Americas-life-expect-bad)'}
p <- ggplot(gap_asia_2007, aes(x = lifeExp, y = country)) +
  geom_point(color = "#0072B2", size = 2.5) +
  scale_x_continuous(name = "life expectancy (years)",
                     limits = c(59.7, 81.5),
                     expand = c(0, 0)) +
  scale_y_discrete(name = NULL, expand = c(0, 0.5)) +
  theme_minimal_grid() +
  theme(axis.ticks.length = grid::unit(0, "pt"),
        axis.title = element_text(size = 12),
        plot.margin = margin(7, 21, 7, 7))

stamp_bad(p)
```


(ref:internet-over-time) Internet adoption over time, for select countries. Data source: World Bank

```{r internet-over-time, fig.width = 8.5, fig.cap = '(ref:internet-over-time)'}
country_list = c("United States", "China", "India", "Japan", "Algeria",
                 "Brazil", "Germany", "France", "United Kingdom", "Italy", "New Zealand",
                 "Canada", "Mexico", "Chile", "Argentina", "Norway", "South Africa", "Kenya",
                 "Israel", "South Africa", "Iceland")

internet_short <- filter(internet, country %in% country_list) %>%
  mutate(users = ifelse(is.na(users), 0, users))

internet_summary <- internet_short %>%
  group_by(country) %>%
  summarize(year1 = min(year[users > 0]),
            last = users[n()]) %>%
  arrange(last, desc(year1))

internet_short <- internet_short %>%
  mutate(country = factor(country, levels = internet_summary$country))

ggplot(filter(internet_short, year > 1993),
       aes(x = year, y = country, fill = users)) +
  geom_tile(color = "white", size = 0.25) +
  scale_fill_viridis_c(option = "A", begin = 0.05, end = 0.98,
                       limits = c(0, 100),
                       name = "internet users / 100 people",
                       guide = guide_colorbar(direction = "horizontal",
                                              label.position = "bottom",
                                              title.position = "top",
                                              ticks = FALSE,
                                              barwidth = grid::unit(3.5, "in"),
                                              barheight = grid::unit(0.2, "in"))) +
  scale_x_continuous(expand = c(0, 0), name = NULL) +
  scale_y_discrete(name = NULL, position = "right") +
  theme_half_open(12) +
  theme(axis.line = element_blank(),
        axis.ticks = element_blank(),
        axis.ticks.length = grid::unit(0, "pt"),
        plot.title = element_text(size = 14, face = "bold"),
        plot.subtitle = element_text(size = 12),
        plot.caption = element_text(size = 10),
        legend.position = "top",
        legend.justification = "left",
        legend.title.align = 0.5,
        legend.title = element_text(size = 10.286),
        plot.margin = margin(14, 14, 7, 14))
```
