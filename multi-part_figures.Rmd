```{r echo = FALSE, message = FALSE, warning = FALSE}
# run setup script
source("_common.R")
```

# Multi-part figures {#multi-part-figures}

(ref:titanic-passenger-breakdown) Breakdown of passengers on the Titanic by gender, survival, and class in which they traveled (1st, 2nd, or 3rd).

```{r titanic-passenger-breakdown, fig.cap = '(ref:titanic-passenger-breakdown)'}
titanic %>% mutate(surv = ifelse(survived == 0, "died", "survived")) %>%
  ggplot(aes(sex, fill = sex)) + geom_bar() +
    facet_grid(class ~ surv, scales = "free_x") +
    scale_x_discrete(name = NULL) + 
    scale_y_continuous(limits = c(0, 195), expand = c(0, 0)) +
    scale_fill_manual(values = c("#D55E00D0", "#0072B2D0"), guide = "none") +
    theme_dviz_hgrid(rel_small = 1) +
    theme(axis.line = element_blank(),
          axis.ticks.length = grid::unit(0, "pt"),
          axis.ticks = element_blank(),
          axis.text.x = element_text(margin = margin(7, 0, 0, 0)),
          strip.text = element_text(margin = margin(3.5, 3.5, 3.5, 3.5)),
          strip.background  = element_rect(fill = "grey80", colour = "grey80",
                                            linetype = 1, size = 0.25),
          panel.border = element_rect(colour = "grey80", fill = NA, linetype = 1,
                                      size = 1.))
```

(ref:BA-degrees-variable-y-lims) Trends in Bachelor's Degrees conferred by U.S. institutions of higher learning. Shown are all degree areas that represent, on average, more than 4% of all degrees. This figure is labeled as bad because all panels use different *y*-axis ranges, and this choice obscures the relative sizes of the different degree areas. Data Source: National Center for Education Statistics

```{r BA-degrees-variable-y-lims, fig.width = 8.5, fig.asp = 0.8, fig.cap = '(ref:BA-degrees-variable-y-lims)'}
BA_degrees %>% 
  mutate(field = ifelse(field == "Communication, journalism, and related programs",
                        "Communication, journalism, and related", field)) -> BA_df

BA_df %>% group_by(field) %>%
  summarize(mean_perc = mean(perc)) %>%
  arrange(desc(mean_perc)) -> BA_top

top_fields <- filter(BA_top, mean_perc>0.04)$field

BA_top_degrees <- filter(BA_df, field %in% top_fields) %>%
  mutate(field = factor(field, levels = top_fields)) %>%
  arrange(field)

p <- ggplot(BA_top_degrees, aes(year, perc)) + 
  geom_line(color = "#0072B2") + 
  facet_wrap(~field, labeller = label_wrap_gen(width = 25), ncol = 3,
             scales = "free") +
  ylab("percent") +
  theme_dviz_hgrid() +
  theme(strip.text = element_text(margin = margin(7, 7, 3, 7)),
        panel.spacing.x = grid::unit(14, "pt"),
        plot.margin = margin(3.5, 14, 3.5, 0)) 

stamp_bad(p)
```

(ref:BA-degrees-fixed-y-lims) Trends in Bachelor's Degrees conferred by U.S. institutions of higher learning. Shown are all degree areas that represent, on average, more than 4% of all degrees. Data Source: National Center for Education Statistics

```{r BA-degrees-fixed-y-lims, fig.width = 8.5, fig.asp = 0.8, fig.cap = '(ref:BA-degrees-fixed-y-lims)'}
ggplot(BA_top_degrees, aes(year, perc)) + 
  geom_line(color = "#0072B2") + 
  facet_wrap(~field, labeller = label_wrap_gen(width = 25), ncol = 3,
             scales = "free") +
  scale_y_continuous(limits = c(0, 0.241), expand = c(0, 0),
                     name = "percent") +
  theme_dviz_hgrid() +
  theme(strip.text = element_text(margin = margin(7, 7, 3, 7)),
        panel.spacing.x = grid::unit(14, "pt"),
        plot.margin = margin(3.5, 14, 3.5, 0)) 

```


(ref:Aus-athletes-composite) Physiology and body-composition of male and female athletes. (a) The data set encompasses 73 female and 85 male professional athletes. (b) Male athletes tend to have higher red blood cell counts (RBC count, reported in units of $10^{12}$ per liter) than female athletes, but there are no such differences for white blood cell counts (WBC count, reported in units of $10^{9}$ per liter). (c) Male athletes tend to have a lower body fat percentage than female athletes performing in the same sport. Data source: @Telford-Cunningham-1991

```{r Aus-athletes-composite, fig.asp = 0.75, fig.cap = '(ref:Aus-athletes-composite)'}
male_sport <- unique(filter(Aus_athletes, sex=="m")$sport)
female_sport <- unique(filter(Aus_athletes, sex=="f")$sport)
both_sport <- male_sport[male_sport %in% female_sport]
athletes_df <- filter(Aus_athletes, sport %in% both_sport) %>%
  mutate(sport = case_when(sport == "track (400m)" ~ "track",
                           sport == "track (sprint)" ~ "track",
                           TRUE ~ sport),
         sex = factor(sex, levels = c("f", "m")))

p1 <- ggplot(athletes_df, aes(x = sex, fill = sex)) + 
  geom_bar() +
  scale_y_continuous(limits = c(0, 95), expand = c(0, 0), name = "number") +
  scale_x_discrete(name = NULL, labels = c("female", "male")) +
  scale_fill_manual(values = c("#D55E00D0", "#0072B2D0"), guide = "none") +
  theme_dviz_hgrid(12, rel_small = 1) + 
  theme(#axis.line.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.ticks.length = grid::unit(0, "pt"),
        plot.margin = margin(2, 7, 0, 0))

p2 <- ggplot(athletes_df, aes(x = rcc, y = wcc, fill = sex)) + 
  geom_point(pch = 21, color = "white", size = 2.5) +
  scale_x_continuous(limits = c(3.8, 6.75), name = NULL) +
  scale_y_continuous(limits = c(2.2, 11.), expand = c(0, 0), name = "WBC count") +
  scale_fill_manual(values = c("#D55E00D0", "#0072B2D0"), guide = "none") +
  theme_dviz_hgrid(12, rel_small = 1) +
  theme(plot.margin = margin(2, 0, 0, 0))

p_row <- plot_grid(p1, p2, labels = "auto", align = 'h', rel_widths = c(0.7, 1)) +
  draw_text("RBC count", x = 1, y = 0, size = 12, hjust = 1, vjust = -0.02,
            family = dviz_font_family) + 
  theme(plot.margin = margin(0, 0, 7, 0))

GeomBP <- GeomBoxplot
GeomBP$draw_key <- draw_key_polygon

p3 <- ggplot(athletes_df, aes(x = sport, y = pcBfat, color = sex, fill = sex)) + 
  stat_boxplot(width = 0.5, geom = GeomBP) +
  scale_color_manual(values = c("#D55E00", "#0072B2"), name = NULL,
                     labels = c("female   ", "male")) +
  scale_fill_manual(values = c("#D55E0040", "#0072B240"), guide = "none") +
  scale_x_discrete(name = NULL) +
  scale_y_continuous(name = "% body fat") +
  guides(color = guide_legend(override.aes = list(fill = c("#D55E00D0", "#0072B2D0"),
                                                  color = "white", size = 2),
                              direction = "horizontal")) +
  theme_dviz_hgrid(12, rel_small = 1) +
  theme(axis.line.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.ticks.length = grid::unit(0, "pt"),
        legend.position = c(1., 0.9),
        legend.justification = "right")

plot_grid(p_row, p3, ncol = 1, labels = c("", "c"))
```
